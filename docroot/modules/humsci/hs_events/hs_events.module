<?php

/**
 * @file
 * hs_events.mdoule
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */
function hs_events_event_collections_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  // On the ECK entity, if the instructor person is set, use that to display.
  if (!empty($build['field_speaker_person']['#items'])) {
    unset($build['title']);
  }
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function hs_events_node_delete(EntityInterface $entity) {
  /** @var \Drupal\entity_usage\EntityUsage $entity_usage */
  $entity_usage = \Drupal::service('entity_usage.usage');
  $entity_usage->listSources($speaker);
  if ($entity->bundle() == 'hs_event') {
    $speakers = $entity->get('field_hs_event_speaker')->getValue();

    // When running a migration rollback the referenced entities are not deleted
    // so we have to delete them manually. Deleting via the UI does not have
    // the same issue.
    foreach ($speakers as $speaker_value) {
      $speaker = \Drupal::entityTypeManager()
        ->getStorage('event_collections')
        ->load($speaker_value['target_id']);
      $entity_usage->listUsage($speaker);
      if ($speaker) {
        $speaker->delete();
      }
    }
  }
}
