<?php

/**
 * @file
 * su_humsci_profile.install
 */

use Drupal\user\Entity\User;
use Drupal\user\RoleInterface;
use Drupal\shortcut\Entity\Shortcut;
use Drupal\Core\Config\FileStorage;

/**
 * Implements hook_install().
 */
function su_humsci_profile_install() {
  // Assign user 1 the "administrator" role.
  $user = User::load(1);
  $user->roles[] = 'administrator';
  $user->save();

  // We install some menu links, so we have to rebuild the router, to ensure the
  // menu links are valid.
  \Drupal::service('router.builder')->rebuildIfNeeded();

  // Allow authenticated users to use shortcuts.
  user_role_grant_permissions(RoleInterface::AUTHENTICATED_ID, ['access shortcuts']);

  // Populate the default shortcut set.
  $shortcut = Shortcut::create([
    'shortcut_set' => 'default',
    'title' => t('Add content'),
    'weight' => -20,
    'link' => ['uri' => 'internal:/node/add'],
  ]);
  $shortcut->save();

  $shortcut = Shortcut::create([
    'shortcut_set' => 'default',
    'title' => t('All content'),
    'weight' => -19,
    'link' => ['uri' => 'internal:/admin/content'],
  ]);
  $shortcut->save();

  // Allow all users to use search.
  user_role_grant_permissions(RoleInterface::ANONYMOUS_ID, ['search content']);
  user_role_grant_permissions(RoleInterface::AUTHENTICATED_ID, ['search content']);
}

/**
 * Enables config readonly module after profile finishes.
 */
function su_humsci_profile_lock_config(&$install_state) {
  install_finished($install_state);
  \Drupal::service('module_installer')->install(['hs_config_readonly']);
}

/**
 * Completely delete a field from the database.
 *
 * @param string $entity_type
 *   Entity type id.
 * @param string $field_name
 *   Machine name of field.
 */
function su_humsci_profile_delete_field($entity_type, $field_name) {
  $field_storage = \Drupal\field\Entity\FieldStorageConfig::load("$entity_type.$field_name");
  if (!$field_storage) {
    return;
  }
  su_humsci_profile_delte_field_from_views($field_name);
  $field_configs = [];
  /** @var \Drupal\Core\Entity\EntityTypeBundleInfo $bundle_info */
  $bundle_info = \Drupal::service('entity_type.bundle.info');
  foreach (array_keys($bundle_info->getBundleInfo($entity_type)) as $bundle) {
    $field_configs[] = "$entity_type.$bundle.$field_name";
  }
  $field_configs = \Drupal\field\Entity\FieldConfig::loadMultiple($field_configs);

  /** @var \Drupal\field\Entity\FieldConfig $field_config */
  foreach ($field_configs as $field_config) {
//    $field_config->delete();
  }
//  $field_storage->delete();
}

function su_humsci_profile_delte_field_from_views($field_name) {
  /** @var \Drupal\views\Entity\View $view */
  foreach (\Drupal\views\Entity\View::loadMultiple() as $view) {
    $displays = $view->get('display');
    foreach ($displays as &$display) {
      unset($display['display_options']['row']['pattern_mapping']["views_row:$field_name"]);
      unset($display['display_options']['fields'][$field_name]);
    }
    $view->set('display', $displays);
    $view->save();
  }
}

/**
 * Create config split entities.
 */
function su_humsci_profile_update_8002() {
  \Drupal::service('module_installer')->install([
    'config_split',
    'config_ignore',
  ]);

  // Install all the default configs first which includes environment specific
  // config splits.
  $source = new FileStorage('../config/default');
  /** @var \Drupal\Core\Config\CachedStorage $config_storage */
  $config_storage = \Drupal::service('config.storage');
  foreach ($source->listAll() as $name) {
    if (strpos($name, 'config_split') !== FALSE || strpos($name, 'config_ignore') !== FALSE) {
      $config_storage->write($name, $source->read($name));
    }
  }

  // Install the config splits from the individual site config directory.
  $file_dir = \Drupal::service('file_system')
    ->realpath(file_default_scheme() . "://");
  $site_path = str_replace('/files', '', $file_dir);
  $site_dir = substr($site_path, strrpos($site_path, '/') + 1);

  if (is_dir("../config/$site_dir")) {
    $source = new FileStorage("../config/$site_dir");
    /** @var \Drupal\Core\Config\CachedStorage $config_storage */
    $config_storage = \Drupal::service('config.storage');
    foreach ($source->listAll() as $name) {
      if (strpos($name, 'config_split') !== FALSE) {
        $config_storage->write($name, $source->read($name));
      }
    }
  }
}

/**
 * Uninstalls search module.
 */
function su_humsci_profile_update_8003() {
  /** @var \Drupal\Core\Extension\ModuleInstallerInterface $module_installer */
  $module_installer = \Drupal::service('module_installer');
  $module_installer->uninstall(['search']);
}

/**
 * Invalidate sample content.
 */
function su_humsci_profile_update_8004() {
  \Drupal::database()
    ->update('key_value_expire')
    ->fields(['expire' => 0])
    ->condition('collection', 'tempstore.shared.layout_builder.sample_entity')
    ->execute();
}

/**
 * Create CI Config Split settings.
 */
function su_humsci_profile_update_8005() {
  $source = new FileStorage('../config/default');
  /** @var \Drupal\Core\Config\CachedStorage $config_storage */
  $config_storage = \Drupal::service('config.storage');
  $config_storage->write('config_split.config_split.ci', $source->read('config_split.config_split.ci'));
}

/**
 * Update config ignore settings.
 */
function su_humsci_profile_update_8006() {
  $config = \Drupal::configFactory()->getEditable('config_ignore.settings');
  if ($ignored_entities = $config->get('ignored_config_entities')) {
    $ignored_entities[] = 'user.role.*:permissions';
    $config->set('ignored_config_entities', $ignored_entities);
    $config->save();
  }
}

/**
 * Give site managers permission to view user list.
 */
function su_humsci_profile_update_8007() {
  $site_manager = \Drupal\user\Entity\Role::load('site_manager');
  $site_manager->grantPermission('view user list');
  $site_manager->save();
}

/**
 * Add view status to config ignore.
 */
function su_humsci_profile_update_8008() {
  $config = \Drupal::configFactory()->getEditable('config_ignore.settings');
  if ($ignored_entities = $config->get('ignored_config_entities')) {
    $ignored_entities[] = 'views.view.hs_*:status';
    $config->set('ignored_config_entities', $ignored_entities);
    $config->save();
  }
}